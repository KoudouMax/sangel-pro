{% set image_url = node.field_image_url.value ?? '' %}
{% set price = node.field_price.value is not empty ? node.field_price.value|number_format(0, ',', ' ') : '' %}
{% set sku = node.field_sku.value ?? '' %}
{% set client_type = node.field_client_type.entity ? node.field_client_type.entity.label : '' %}
{% set family_label = node.field_family.entity ? node.field_family.entity.label : '' %}
{% set sub_family_label = node.field_sub_family.entity ? node.field_sub_family.entity.label : '' %}
{% set has_price = price is not empty %}

{% set weight_value = node.field_weight.value ?? '' %}
{% set unit_weight = node.field_unit_weight.value ?? '' %}
{% set weight_display = '' %}
{% if weight_value or unit_weight %}
	{% set formatted_weight = weight_value ? weight_value|number_format(0, ',', ' ') : '' %}
	{% set weight_display = formatted_weight ~ (unit_weight ? ' ' ~ unit_weight : '') %}
{% endif %}

{% set product_id = node.id() %}
{% set has_product = product_id is not empty %}

{% set url = has_product ? path('entity.node.canonical', {'node': product_id}) : '' %}
{% set catalog_remove_target = has_product ? 'catalog-item-' ~ product_id : '' %}
{% set catalog_remove_url = has_product ? path('sangel_product.catalog_remove', {'node': product_id}, {'query': {'target': catalog_remove_target}}) : '' %}
{% set export_url = has_product ? catalog_export_url(product_id) : '' %}
{% set cart_add_url = has_product ? path('sangel_order.cart_add', {'node': product_id}) : '' %}
{% set route_node = app.request ? app.request.attributes.get('node') : null %}
{% set hide_remove_action = route_node and route_node.bundle() == 'export' %}
{% set show_cart_action = is_client %}
{% set show_actions = show_cart_action or (not hide_remove_action) %}

{{ attach_library('sangelpro_theme/product-actions') }}

{% set classes = ['sangel-export-item'] %}
{% if hide_remove_action %}
	{% set classes = classes|merge(['sangel-export-item--static']) %}
{% endif %}

{% set attributes = attributes.addClass(classes).setAttribute('id', catalog_remove_target) %}

<article{{attributes}}>
	<div class="sangel-export-item__image">
		{% if url %}
			<a href="{{ url }}" class="sangel-export-item__image-link">
		{% else %}
			<span class="sangel-export-item__image-link">
		{% endif %}
			{% if image_url %}
				<img src="{{ image_url|escape }}" alt="{{ label|escape }}" loading="lazy"/>
			{% else %}
				<span aria-hidden="true">{{ 'Image'|t }}</span>
			{% endif %}
		{% if url %}
			</a>
		{% else %}
			</span>
		{% endif %}
	</div>

	<div class="sangel-export-item__body">
		<div class="sangel-export-item__title-line">
			{% if url %}
				<a href="{{ url }}" class="sangel-export-item__title">
					{{ label }}
				</a>
			{% else %}
				<span class="sangel-export-item__title">{{ label }}</span>
			{% endif %}
			{% if sku %}
				<span class="sangel-export-item__sku">{{ sku }}</span>
			{% endif %}
		</div>

		<div class="sangel-export-item__details">
			{% if has_price %}
				<span class="sangel-export-item__price">{{ price }}&nbsp;F&nbsp;CFA</span>
			{% endif %}
			{% if weight_display %}
				<span class="sangel-export-item__badge">{{ weight_display }}</span>
			{% endif %}
		</div>

		<ul class="sangel-export-item__meta">
			{% if client_type %}
				<li class="sangel-export-item__meta-item">
					<span class="sangel-export-item__meta-label">{{ 'Client'|t }}</span>
					<span class="sangel-export-item__meta-value">{{ client_type }}</span>
				</li>
			{% endif %}
			{% if family_label %}
				<li class="sangel-export-item__meta-item">
					<span class="sangel-export-item__meta-label">{{ 'Famille'|t }}</span>
					<span class="sangel-export-item__meta-value">{{ family_label }}</span>
				</li>
			{% endif %}
			{% if sub_family_label %}
				<li class="sangel-export-item__meta-item">
					<span class="sangel-export-item__meta-label">{{ 'Sous-famille'|t }}</span>
					<span class="sangel-export-item__meta-value">{{ sub_family_label }}</span>
				</li>
			{% endif %}
		</ul>
	</div>

	{% if show_actions and has_product %}
		<div class="sangel-export-item__actions">
			{% if show_cart_action %}
				<a href="{{ cart_add_url }}" class="sangel-export-item__action sangel-export-item__action--primary sangel-card__button--ajax" data-sangel-ajax-url="{{ cart_add_url }}" data-sangel-counter="#sangel-order-cart-count">
					{{ 'Ajouter au panier'|t }}
				</a>
			{% endif %}
			{% if not hide_remove_action %}
				<a href="{{ catalog_remove_url }}" class="use-ajax sangel-export-item__action sangel-export-item__action--danger" data-sangel-ajax-url="{{ catalog_remove_url }}" data-sangel-counter="#sangel-product-catalog-count" data-remove-target="#{{ catalog_remove_target }}">
					<span aria-hidden="true">âœ•</span>
					<span>{{ 'Retirer'|t }}</span>
				</a>
			{% endif %}
		</div>
	{% endif %}
</article>

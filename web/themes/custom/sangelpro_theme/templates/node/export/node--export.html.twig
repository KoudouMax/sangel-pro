{% set export_products = node.field_export_products ?? [] %}
{% set product_count = export_products|length %}
{% set has_products = product_count > 0 %}

{% set file_entity = node.field_export_file.entity ?? NULL %}
{% if not file_entity and node.hasField('field_export_file') and node.get('field_export_file') is iterable %}
  {% for item in node.get('field_export_file') %}
    {% if item.entity %}
      {% set file_entity = item.entity %}
    {% endif %}
  {% endfor %}
{% endif %}

{% set catalog = node.field_export_catalog.entity ?? NULL %}
{% set catalog_label = catalog ? catalog.label() : '' %}
{% set owner = node.getOwner() %}
{% set owner_name = owner ? owner.getDisplayName() : '—' %}

{% set fallback_export_url = (catalog and catalog.id) ? path('sangel_catalog.export', {'node': catalog.id}) : '' %}
{% set export_url = file_entity ? file_url(file_entity.getFileUri()) : fallback_export_url %}
{% set products_export_url = export_products_url(node.id()) %}
{% set add_export_url = add_export_url|default('') %}
{% set edit_export_url = edit_export_url|default('') %}

{% set note_render_array = content.field_export_note ?? NULL %}
{% set note_markup = note_render_array ? note_render_array|render|trim : '' %}
{% set show_note_section = note_markup or edit_export_url %}

{% set export_filename = file_entity ? file_entity.getFilename() : '' %}
{% set export_mime = file_entity and file_entity.getMimeType() ? file_entity.getMimeType() : '' %}
{% set export_size = file_entity and file_entity.getSize() ? file_entity.getSize() : 0 %}
{% set created_timestamp = node.getCreatedTime() %}
{% set updated_timestamp = node.getChangedTime() %}

{% set export_size_label = '—' %}
{% if export_size %}
  {% if export_size >= 1048576 %}
    {% set export_size_label = (export_size / 1048576)|number_format(2, ',', ' ') ~ '&nbsp;Mo' %}
  {% else %}
    {% set export_size_label = (export_size / 1024)|number_format(1, ',', ' ') ~ '&nbsp;Ko' %}
  {% endif %}
{% endif %}

{% set format_map = {
  'text/csv': 'CSV',
  'text/plain': 'TXT',
  'application/json': 'JSON',
  'application/xml': 'XML',
  'text/xml': 'XML',
  'application/vnd.ms-excel': 'XLS',
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'XLSX',
} %}
{% set export_format = export_mime ? format_map[export_mime]|default(export_mime) : (export_url ? export_url|split('.')|last|upper : '—') %}

{% set export_view = node.field_export_view.value ?? '' %}
{% set export_display = node.field_export_display.value ?? '' %}
{% set export_context_markup = content.field_export_context ? content.field_export_context|render|trim : '' %}

{% set export_body %}
  {{ content|without('field_export_products', 'field_export_file', 'field_export_catalog', 'field_export_note', 'field_export_view', 'field_export_display', 'field_export_context') }}
{% endset %}
{% set export_body = export_body|trim %}

{% set metrics = [
  {'label': 'Catalogue'|t, 'value': catalog_label ?: '—'},
  {'label': 'Auteur'|t, 'value': owner_name},
  {'label': 'Identifiant'|t, 'value': '#' ~ node.id()},
  {'label': 'Format'|t, 'value': export_format},
  {'label': 'Taille'|t, 'value': export_size_label, 'raw': TRUE},
  {'label': 'Nom du fichier'|t, 'value': export_filename ?: '—'},
  {'label': 'Produits'|t, 'value': product_count ? product_count ~ ' ' ~ (product_count > 1 ? 'articles'|t : 'article'|t) : '0'}
] %}

<article{{ attributes.addClass('relative', 'overflow-hidden', 'rounded-3xl', 'border', 'border-sangel-ice-strong', 'bg-white') }}>
  <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-sangel-primary/12 via-white to-sangel-primary/5 opacity-0 transition duration-500 hover:opacity-100" aria-hidden="true"></div>

  <div class="relative space-y-10 p-6 md:p-8">
    <header class="space-y-6">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div class="space-y-2">
          <p class="text-xs font-semibold text-sangel-primary/70">{{ 'Export catalogue'|t }}</p>
          <h1 class="text-sm font-semibold text-sangel-text">{{ label }}</h1>
          <p class="text-sm text-sangel-text/70">{{ 'Gerer le fichier genere, la note commerciale et l historique de cet export.'|t }}</p>
        </div>

        <div class="flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:items-center lg:flex-col lg:items-end">
          {% if export_url %}
            <a href="{{ export_url }}" class="inline-flex items-center justify-center gap-2 rounded-full bg-sangel-primary px-5 py-2.5 text-xs font-semibold text-white shadow-sm transition hover:bg-sangel-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M7.5 11.25 12 15.75m0 0 4.5-4.5M12 15.75V3"/>
              </svg>
              <span>{{ 'Telecharger le fichier'|t }}</span>
            </a>
          {% endif %}

          {# {% if products_export_url %}
            <a href="{{ products_export_url }}" class="inline-flex items-center justify-center gap-2 rounded-full border border-sangel-primary px-5 py-1 text-xs font-semibold text-sangel-primary transition hover:bg-sangel-primary/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.4" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
              </svg>
              <span>{{ 'Exporter les produits'|t }}</span>
            </a>
          {% endif %} #}

          {# {% if add_export_url %}
            <a href="{{ add_export_url }}" class="inline-flex items-center justify-center gap-2 rounded-full border border-dashed border-sangel-primary/60 px-5 py-1 text-xs font-semibold text-sangel-primary transition hover:border-sangel-primary hover:bg-sangel-primary/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
              </svg>
              <span>{{ 'Creer un nouvel export'|t }}</span>
            </a>
          {% endif %} #}

          {% if edit_export_url %}
            <a href="{{ edit_export_url }}#edit-field-export-note-0-value" class="inline-flex items-center justify-center gap-2 rounded-full border border-dashed border-sangel-primary px-5 py-1 text-xs font-semibold text-sangel-primary transition hover:bg-sangel-primary/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487a2.25 2.25 0 0 1 3.182 3.182L10.06 17.653a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 13.5v6"/>
              </svg>
              <span>{{ 'Modifier la note'|t }}</span>
            </a>
          {% endif %}

          <a href="{{ path('sangel_core.manage_catalogs') }}" class="inline-flex items-center justify-center gap-2 rounded-full px-5 py-2.5 text-sm font-semibold text-sangel-text/70 transition hover:text-sangel-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
            <span>{{ 'Retour aux catalogues'|t }}</span>
          </a>
        </div>
      </div>

      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-2xl border border-sangel-ice-strong bg-white/70 p-4 shadow-sm">
          <p class="text-xs font-semibold uppercase tracking-[0.18em] text-sangel-text/50">{{ 'Cree le'|t }}</p>
          <p class="mt-1 text-sm font-semibold text-sangel-text">{{ created_timestamp ? created_timestamp|date('d/m/Y H:i') : '—' }}</p>
        </div>
        <div class="rounded-2xl border border-sangel-ice-strong bg-white/70 p-4 shadow-sm">
          <p class="text-xs font-semibold uppercase tracking-[0.18em] text-sangel-text/50">{{ 'Mise a jour'|t }}</p>
          <p class="mt-1 text-sm font-semibold text-sangel-text">{{ updated_timestamp ? updated_timestamp|date('d/m/Y H:i') : '—' }}</p>
        </div>
        {% for metric in metrics %}
          <div class="rounded-2xl border border-sangel-ice-strong bg-white/70 p-4 shadow-sm">
            <p class="text-xs font-semibold uppercase tracking-[0.18em] text-sangel-text/50">{{ metric.label }}</p>
            <p class="mt-1 text-sm font-semibold text-sangel-text">
              {% if metric.raw|default(FALSE) %}
                {{ metric.value|raw }}
              {% else %}
                {{ metric.value }}
              {% endif %}
            </p>
          </div>
        {% endfor %}
      </div>
    </header>

    {% if show_note_section %}
      <section class="rounded-3xl border border-sangel-primary/30 bg-sangel-primary/7 p-6 shadow-sm">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-sangel-primary text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487a2.25 2.25 0 0 1 3.182 3.182L10.06 17.653a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897z"/>
              </svg>
            </div>
            <div>
              <h2 class="text-sm font-semibold uppercase tracking-[0.16em] text-sangel-primary/80">{{ 'Note commerciale'|t }}</h2>
              <p class="text-xs text-sangel-text/60">{{ 'Visible uniquement par les utilisateurs autorises.'|t }}</p>
            </div>
          </div>
          {% if edit_export_url %}
            <a href="{{ edit_export_url }}#edit-field-export-note-0-value" class="inline-flex items-center gap-2 rounded-full border border-dashed border-sangel-primary px-4 py-1 text-xs font-semibold text-sangel-primary transition hover:bg-sangel-primary/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487a2.25 2.25 0 0 1 3.182 3.182L10.06 17.653a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 13.5v6"/>
              </svg>
              <span>{{ 'Modifier la note'|t }}</span>
            </a>
          {% endif %}
        </div>
        <div class="mt-4 text-sm leading-relaxed text-sangel-text/80 whitespace-pre-line">
          {% if note_markup %}
            {{ note_markup|raw }}
          {% else %}
            <span class="italic text-sangel-text/60">{{ "Aucune note n'a encore ete ajoutee."|t }}</span>
          {% endif %}
        </div>
      </section>
    {% endif %}

    <section class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
      <div class="space-y-6">
        {% if export_body %}
          <section class="space-y-4 rounded-3xl border border-sangel-ice-strong bg-white/95 p-6 shadow-inner">
            <header class="space-y-1">
              <h2 class="text-base font-semibold text-sangel-text">{{ 'Informations detaillees'|t }}</h2>
              <p class="text-xs text-sangel-text/60">{{ 'Champs supplementaires exposes par la configuration Drupal.'|t }}</p>
            </header>
            <div class="space-y-4 text-sm text-sangel-text/80">{{ export_body }}</div>
          </section>
        {% endif %}

        {# <section class="space-y-4 rounded-3xl border border-sangel-ice-strong bg-white p-6 shadow-sm">
          <header class="space-y-1">
            <h2 class="text-base font-semibold text-sangel-text">{{ 'Contexte technique'|t }}</h2>
            <p class="text-xs text-sangel-text/60">{{ 'Valeurs utiles pour l audit et la reproduction de l export.'|t }}</p>
          </header>
          <dl class="space-y-3 text-sm text-sangel-text/70">
            {% if export_filename %}
              <div class="flex flex-col gap-1 rounded-2xl bg-sangel-ice/30 p-4">
                <dt class="text-xs font-semibold uppercase tracking-[0.16em] text-sangel-text/50">{{ 'Fichier'|t }}</dt>
                <dd class="flex items-center gap-3 text-sm font-semibold text-sangel-text">
                  <span class="truncate">{{ export_filename }}</span>
                  {% if export_url %}
                    <a href="{{ export_url }}" class="inline-flex items-center gap-1 rounded-full border border-sangel-primary/40 px-3 py-1 text-xs font-semibold uppercase tracking-[0.16em] text-sangel-primary transition hover:bg-sangel-primary/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/30 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
                      <span aria-hidden="true">⤓</span>
                      <span>{{ 'Telecharger'|t }}</span>
                    </a>
                  {% endif %}
                </dd>
              </div>
            {% endif %}
            <div class="flex flex-col gap-1 rounded-2xl bg-sangel-ice/30 p-4">
              <dt class="text-xs font-semibold uppercase tracking-[0.16em] text-sangel-text/50">{{ 'Vue'|t }}</dt>
              <dd class="font-semibold text-sangel-text">{{ export_view ?: '—' }}</dd>
            </div>
            <div class="flex flex-col gap-1 rounded-2xl bg-sangel-ice/30 p-4">
              <dt class="text-xs font-semibold uppercase tracking-[0.16em] text-sangel-text/50">{{ 'Affichage'|t }}</dt>
              <dd class="font-semibold text-sangel-text">{{ export_display ?: '—' }}</dd>
            </div>
            {% if export_context_markup %}
              <div class="rounded-2xl bg-sangel-ice/10 p-4 text-xs text-sangel-text/70">{{ export_context_markup|raw }}</div>
            {% endif %}
          </dl>
        </section> #}
      </div>

      <aside class="space-y-6">
        {# <section class="space-y-4 rounded-3xl border border-sangel-ice-strong bg-white p-6 shadow-sm">
          <h2 class="text-sm font-semibold uppercase text-sangel-text/60">{{ 'Publication'|t }}</h2>
          <div class="space-y-3 text-sm text-sangel-text/70">
            <div class="flex items-center justify-between rounded-2xl bg-sangel-ice/25 px-4 py-3">
              <span class="font-semibold text-sangel-text/60">{{ 'Statut'|t }}</span>
              <span class="font-semibold text-sangel-text">{{ node.isPublished() ? 'Publie'|t : 'Brouillon'|t }}</span>
            </div>
            {% if updated_timestamp %}
              <div class="flex items-center justify-between rounded-2xl bg-sangel-ice/25 px-4 py-3">
                <span class="font-semibold text-sangel-text/60">{{ 'Derniere mise a jour'|t }}</span>
                <span class="font-semibold text-sangel-text">{{ updated_timestamp|date('d/m/Y H:i') }}</span>
              </div>
            {% endif %}
          </div>
        </section> #}

        <section class="space-y-3 rounded-3xl border border-sangel-ice-strong bg-white p-6 shadow-sm">
          <h2 class="text-sm font-semibold uppercase text-sangel-text/60">{{ 'Actions rapides'|t }}</h2>
          <ul class="space-y-3 text-xs font-semibold text-sangel-primary/80">
            {% if export_url %}
              <li>
                <a href="{{ export_url }}" class="inline-flex text-xs items-center gap-2 rounded-full border border-sangel-primary/40 px-4 py-1 transition hover:border-sangel-primary hover:text-sangel-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
                  <span aria-hidden="true">⤓</span>
                  <span>{{ 'Telecharger le fichier'|t }}</span>
                </a>
              </li>
            {% endif %}
            {# {% if products_export_url %}
              <li>
                <a href="{{ products_export_url }}" class="inline-flex text-xs items-center gap-2 rounded-full border border-sangel-primary/40 px-4 py-1 transition hover:border-sangel-primary hover:text-sangel-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
                  <span aria-hidden="true">→</span>
                  <span>{{ 'Exporter les produits'|t }}</span>
                </a>
              </li>
            {% endif %} #}
            {# {% if add_export_url %}
              <li>
                <a href="{{ add_export_url }}" class="inline-flex text-xsitems-center gap-2 rounded-full border border-sangel-primary/40 px-4 py-1 transition hover:border-sangel-primary hover:text-sangel-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
                  <span aria-hidden="true">＋</span>
                  <span>{{ 'Creer un nouvel export'|t }}</span>
                </a>
              </li>
            {% endif %} #}
            <li>
              <a href="{{ edit_export_url ?: path('entity.node.edit_form', {'node': node.id()}) }}" class="inline-flex text-xs items-center gap-2 rounded-full border border-sangel-primary/40 px-4 py-1 transition hover:border-sangel-primary hover:text-sangel-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sangel-primary/35 focus-visible:ring-offset-2 focus-visible:ring-offset-white">
                <span aria-hidden="true">✎</span>
                <span>{{ "Modifier l'export"|t }}</span>
              </a>
            </li>
          </ul>
        </section>
      </aside>
    </section>

  </div>
</article>
